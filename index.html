<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Market Display</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.3/dist/tailwind.min.css" rel="stylesheet"/>
  <style>
    body {
      background-color: #0d1117;
      font-family: 'Courier New', monospace;
      color: #fff;
      padding: 2rem;
    }
    .current-number {
      font-size: 5rem;
      font-weight: bold;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    }
  </style>

  <!-- ✅ Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAWs4V81fLFH6khFkHe0oJIbJeXuZs1DI4",
      authDomain: "dark-tools-93abd.firebaseapp.com",
      databaseURL: "https://dark-tools-93abd-default-rtdb.firebaseio.com",
      projectId: "dark-tools-93abd",
      storageBucket: "dark-tools-93abd.appspot.com",
      messagingSenderId: "1003509016475",
      appId: "1:1003509016475:android:826836719187aa12fc633e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>
</head>
<body>
  <header class="text-center mb-6">
    <h1 class="text-4xl font-extrabold text-blue-500">Market Display</h1>
  </header>

  <div class="text-center text-2xl font-bold text-yellow-400 mb-4">
    <div id="timer">00:30</div>
  </div>

  <!-- Current Number Display -->
  <div id="currentNumberContainer" class="text-center mb-8">
    <div id="currentNumber" class="current-number">--</div>
  </div>

  <!-- History Table -->
  <div id="gameDataContainer" class="max-w-md mx-auto mb-6"></div>

  <script>
    let lastIssueNumber = null;
    let firstLoad = true;
    let uploadedIssues = new Set();

    function updateCurrentNumberDisplay(item) {
      const number = Number(item.number);
      document.getElementById("currentNumber").textContent = number;
    }

    function renderTable(data) {
      const gameDataContainer = document.getElementById('gameDataContainer');
      gameDataContainer.innerHTML = '';
      const table = document.createElement('table');
      table.className = 'w-full text-sm text-center bg-gray-800';
      table.innerHTML = `
        <thead class="bg-blue-600 text-black">
          <tr>
            <th>Number</th>
          </tr>
        </thead>
        <tbody>
          ${data.map((item) => `
            <tr class="hover:bg-gray-600">
              <td>${item.number}</td>
            </tr>`
          ).join('')}
        </tbody>`;
      gameDataContainer.appendChild(table);
    }

    async function fetchAndUpdate() {
      try {
        const res = await fetch('https://crbbb.com/api/webapi/GetNoaverageEmerdList', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json;charset=UTF-8' },
          body: JSON.stringify({
            pageSize: 10,
            pageNo: 1,
            typeId: 30,
            language: 0,
            random: "62d02162c2234c64b57aa4188c5810b2",
            signature: "9BF7A245709AA054E231D75C404C6527",
            timestamp: Math.floor(Date.now() / 1000)
          })
        });

        const json = await res.json();
        const list = json?.data?.list;
        if (!list?.length) return;

        const latest = list[0];
        const currentIssue = latest.issueNumber;

        // ✅ প্রথমবার: পুরা মার্কেট Firebase এ push
        if (firstLoad) {
          list.forEach((item) => {
            if (!uploadedIssues.has(item.issueNumber)) {
              db.ref('HACK').push({
                number: item.number,
                issueNumber: item.issueNumber,
                time: new Date().toISOString()
              });
              uploadedIssues.add(item.issueNumber);
            }
          });
          firstLoad = false;
          lastIssueNumber = currentIssue;
          updateCurrentNumberDisplay(latest);
          renderTable(list);
          return;
        }

        // ✅ এরপর: শুধুমাত্র নতুন নাম্বার এলে push করবো
        if (currentIssue !== lastIssueNumber && !uploadedIssues.has(currentIssue)) {
          db.ref('HACK').push({
            number: latest.number,
            issueNumber: latest.issueNumber,
            time: new Date().toISOString()
          });
          uploadedIssues.add(currentIssue);
          lastIssueNumber = currentIssue;
          updateCurrentNumberDisplay(latest);
          renderTable(list);
        }

      } catch (error) {
        console.error("Fetch error:", error);
      }
    }

    function updateTimer() {
      const now = new Date();
      const base = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 5, 30, 0);
      if (now < base) base.setDate(base.getDate() - 1);
      const elapsed = Math.floor((now - base) / 1000);
      const remain = 30 - (elapsed % 30);

      document.getElementById("timer").innerText = `00:${String(remain).padStart(2, '0')}`;
      if (remain === 30) fetchAndUpdate();
      setTimeout(updateTimer, 1000);
    }

    document.addEventListener('DOMContentLoaded', () => {
      updateTimer();
      fetchAndUpdate();
    });
  </script>
</body>
</html>